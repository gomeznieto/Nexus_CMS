@using Backend_portafolio.Helper
@using Microsoft.AspNetCore.Http;
@using System.Text.Json;
@model HomeViewModel;

@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Home Page";
}

<div>
    <h1>Panel de Control</h1>
    <!-- COLUMNA 1 -->
    <div class="d-flex w-100 flex-lg-row flex-column">
        <div class=" col-lg-6 col-12 d-flex flex-column gap-2 me-4">

            <!-- RESUMEN -->
            <div class="border-section">
                <p class="fs-5 border-bottom border-1 border-secondary pb-3 fw-bold">Resumen</p>
                <ul class="list-group list-unstyled">
                    <li><p><i class="fa-solid fa-file iconos_home me-3"></i><span class="fw-bold">Cantidad de posts: </span>@Model.ultimosPosts.Count()</p></li>

                    @foreach (var format in Model.formatList)
                    {
                        <li><p><i class="fa-solid fa-thumbtack iconos_home me-3"></i><span class="fw-bold">@format.name:</span> @Model.ultimosPosts.Count(x => x.format_id == format.id)</p></li>
                    }
                </ul>
            </div>
            <!-- FIN RESUMEN -->
            <!-- ULTIMAS ENTRADAS-->
            <div class="border-section">
                <p class="fs-5 border-bottom border-1 border-secondary pb-3 fw-bold">Último post</p>
                <ul class="list-group list-unstyled">
                    @foreach (var format in Model.formatList)
                    {
                        @if (Model.ultimosPosts.Count(x => x.format_id == format.id) == 0)
                        {
                            <li class="d-flex flex-column ">
                                <p class="fw-bold fst-italic"><i class="fa-solid fa-layer-group iconos_home me-1"></i>@format.name</p>
                                <p>
                                    <i class="fas fa-edit iconos_home me-1">
                                    </i>
                                    <span class="date_home ">Sin entradas creadas</span>
                                </p>
                            </li>
                        }
                        else
                        {
                            var ultimoPost = Model.ultimosPosts
                            .Where(x => x.format_id == format.id)
                            .OrderByDescending(x => x.id)
                            .FirstOrDefault();
                            <li class="d-flex flex-column ">
                                <p class="fw-bold fst-italic"><i class="fa-solid fa-layer-group iconos_home me-1"></i>@format.name</p>
                                <p>
                                    <i class="fas fa-edit iconos_home me-1">
                                    </i>
                                    <a href="/posts/Editar/@ultimoPost.id?format=@format.name" class="link_home">@(ultimoPost != null ? ultimoPost.title : "--")</a>
                                    <span class="date_home "> (@ultimoPost.created_at.ToString("dddd, dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-ES")) - @ultimoPost.created_at.ToShortTimeString())</span>
                                </p>
                            </li>
                        }
                    }
                </ul>
            </div>
            <!-- FIN ULTIMAS ENTRADAS-->
            <!-- BUSCADOR DE POST -->
            <div class="border-section">
                <p class="fs-5 border-bottom border-1 border-secondary pb-3 fw-bold">Buscador</p>
                <form method="post" asp-controller="Posts" asp-action="Index" class="d-flex flex-column flex-lg-row justify-content-center align-items-center gap-2">
                    <input type="text" name="buscar" class="form-control input-style" placeholder="Buscar entrada..." />
                    <div class="input-group-append">
                        <button type="submit" class="btn btn-action">Buscar</button>
                    </div>
                </form>
            </div>
            <!-- FIN BUSCADOR DE POST -->
        </div>
        <!-- FIN COLUMNA 1 -->
        <!-- COLUMNA 2 -->
        <div class="col-lg-6 col-12 d-flex flex-column gap-2">
            <!-- ENTRADA RAPIDA -->
            <div class="border-section">
                @if (Model.formatList.Count() > 0)
                {

                    <p class="fs-5 border-bottom border-1 border-secondary pb-3 fw-bold">Entrada rápida</p>
                    <form asp-action="Index" method="post" class="mt-2">

                        <!-- VALIDATION -->
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- HIDDEN -->
                        <input type="hidden" asp-for="user_id" />

                        <!-- CREACION DE ENTRADA -->
                        <div class="mb-3">
                            <input asp-for="title" class="form-control fs-2 fw-bolder" placeholder="Agregar titulo" />
                            <span asp-validation-for="title" class="form-error"></span>
                        </div>

                        <!-- POST -->
                        <div class="mb-3">
                            <!-- STYLES -->
                            <partial name="_TextControl" />

                            <!-- TEXT -->
                            <textarea asp-for="description" class="form-control textarea-style" rows="10" placeholder="Agregar contenido de la entrada" id="post_text"></textarea>
                            <span asp-validation-for="description" class="form-error"></span>
                        </div>

                        <!-- AGREGAR FORMATO -->
                        <div class="mb-3">
                            <h3 class="fs-5">Formato</h3>
                            <select class="form-select select-style" asp-for="format_id">
                                <option disabled selected>Seleccione Formato</option>
                                @foreach (var formato in Model.formatList)
                                {
                                    <option value="@formato.id">@formato.name</option>
                                }
                            </select>
                        </div>

                        <!-- BUTTON -->
                        <button type="submit" class="btn btn-action" onclick="BorradorHome();">Borrador</button>
                        <a asp-action="Index" asp-route-format="@Model.format" class="btn btn-delete"><i class="fa-solid fa-trash"></i> Limpiar</a>
                    </form>
                }
                else
                {
                    <p>Antes de comenzar a publicar entradas, primero debe crear un Formato</p>
                }
            </div>
            <div class="border-section">
                <p class="fs-5 border-bottom border-1 border-secondary pb-3 fw-bold">Secciones</p>
                <div class="mb-3">
                    @if (Model.homeSectionList.Count > 0)
                    {
                        <select class="form-select select-style">
                            <option disabled selected>Seleccione Formato</option>
                            @foreach (var sectionHome in Model.homeSectionList)
                            {
                                <option value="@sectionHome.Id">@sectionHome.Name</option>
                            }
                        </select>
                        <a class="btn btn-edit" onclick="editHomeSection">Editar</a>
                }
                <button class="btn btn-action" id="btnAddSection" onclick="showHomeSectionForm()" mode="edit"><i class="fa-solid fa-plus me-2 mb-2"></i>Agregar Sección</button>
            </div>
            <form method="post" asp-controller="Home" asp-action="CreateHomeSection" class="d-flex flex-row flex-lg-row justify-content-center align-items-center gap-2 hide" id="formHomeSection">
                <input asp-for="@Model.SectionForm.Name" type="text" class="form-control input-style" placeholder="Nombre" />
                <select asp-for="@Model.SectionForm.Order" class="form-select select-style w-25">
                    <option selected>Orden</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="4">5</option>
                    <option value="4">6</option>
                </select>
                <select asp-for="@Model.SectionForm.MaxItems" class="form-select select-style w-25">
                    <option selected>Entradas</option>
                    <option value="6">2</option>
                    <option value="4">4</option>
                    <option value="6">6</option>
                </select>
                <div class="input-group-append">
                    <button type="submit" class="btn btn-action">Crear</button>
                </div>
            </form>
        </div>
    </div>
    <!-- FIN ENTRADA RAPIDA -->
</div>
<!-- FIN COLUMNA 2 -->
</div>


</div>

<script>
    function showHomeSectionForm()
    {
        let form =document.getElementById("formHomeSection");
        let btnAddSection = document.getElementById("btnAddSection");

        if(btnAddSection.getAttribute("mode") == "edit")
        {
            btnAddSection.classList.remove("btn-action");
            btnAddSection.classList.add("btn-delete");
            btnAddSection.setAttribute("mode", "cancel")
            form.classList.remove("hide");
            btnAddSection.innerHTML = "Cancelar";
        }
        else
        {
             btnAddSection.classList.add("btn-action");
            btnAddSection.classList.remove("btn-delete");
            btnAddSection.setAttribute("mode", "edit")
            form.classList.add("hide");
            btnAddSection.innerHTML = "Agregar Sección";
        }
    }

</script>
