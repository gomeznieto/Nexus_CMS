@model PostViewModel

@{
    ViewData["Title"] = "Crear post";
}

<div class="mt-5">
    <h1>Editar @Model.title <span class="@(Model.draft ? "text-borrador" : "text-publicado") date_post">@(Model.draft ? "Borrador" : "Publicado")</span></h1>
    <span class="date_post mb-3"> @Model.created_at.ToString("dddd, dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-ES")) - @Model.created_at.ToShortTimeString()</span>
    <form asp-action="Editar" method="post" class="mt-5 col-md-10 col-12 d-flex flex-row gap-2 me-4" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
        <input type="hidden" asp-for="user_id" />
        <input type="hidden" asp-for="id" id="post_id" />
        <input type="hidden" asp-for="format_id" />
        <input type="hidden" asp-for="@Model.HomeSectionPost.Id" />
        <input type="hidden" asp-for="@Model.HomeSectionPost.PostId" />
        <input type="hidden" asp-for="format" />
        <input type="hidden" asp-for="draft" id="draftCheckBox" />
        <input type="hidden" asp-for="mediaListString" id="imageLinksField" />
        <input type="hidden" asp-for="sourceListString" id="sourceLinksField" />
        <input type="hidden" asp-for="categoryListString" id="categoryListField" />

        <!-- EDICION DE ENTRADA -->
        <div class="border-section col-9">

            <div class="mb-3">
                <input asp-for="title" class="form-control fs-2 fw-bolder" placeholder="Agregar titulo" />
                <span asp-validation-for="title" class="form-error"></span>
            </div>

            <!-- POST -->
            <div class="mb-3">
                @await Component.InvokeAsync("TextControl", new TextControlModel { FieldName = "description", FieldValue = Model.description, EditMode = EditMode.Full })
            </div>

            <!-- IAMGE -->
            <div class="mb-3">
                <h3 class="fs-5">Cover</h3>
                <img src="@(Model.cover != null ? Model.cover : "https://picsum.photos/id/237/200/300")" class="cover-picture rounded-2">
                <input type="file" id="image" name="ImageFile" accept="image/*" asp-for="@Model.ImageFile" class="form-control mt-2">
            </div>


            <!-- EDITAR CATEGORIAS -->
            <div class="mb-3">
                <h3 class="fs-5">Categorias</h3>
                <select class="form-select select-style" id="selectCategory" postId="@Model.id" onchange="addCategory(this)">
                    <option disabled selected>Seleccione categorías</option>
                    @foreach (var category in Model.categories)
                    {
                        <option value="@category.Value">@category.Text</option>
                    }
                </select>

                <div class="mb-3 d-flex" id="categoryContainer"></div>
            </div>

            <h3 class="fs-5">Multi Media</h3>

            <!-- MULTIMEDIA -->
            <!-- Listado editable y eliminable de los media del usuario-->
            @foreach (var media in Model.mediaList)
            {
                <div class="input-group">
                    <select class="form-select mb-3 select-style w-25 input-style-disabled" disabled>
                        @foreach (var types in Model.mediaTypes)
                        {
                            <option selected='@(types.Value == media.mediatype_id.ToString())' value='@types.Value'>@types.Text</option>
                        }
                    </select>
                    <input asp-for="@media.url" id="@media.id" class="form-control mb-3 imgList imgAdd input-style w-50 me-2 input-style-disabled" disabled />
                    <button type="button" class="btn btn-edit h-50 me-2" onclick="editInput(this, 'post')">Editar</button>
                    <button type="button" class="btn btn-delete h-50" onclick="removeInput(this, 'post')">Eliminar</button>
                </div>
            }

            <div id="inputContainerMedia"></div>

            <!-- Boton que permita seguir agregando media -->
            <button type="button" class="btn btn-add mb-3 d-flex" onclick="addInputMedia()">Agregar Multimedia</button>

            <!--LINKS-->
            <h3 class="fs-5">Links</h3>
            @foreach (var link in Model.linkList)
            {
                <div class="input-group">
                    <select class="form-select mb-3 select-style w-25 input-style-disabled" disabled>
                        @foreach (var types in Model.sources)
                        {
                            <option selected='@(types.Value == link.source_id.ToString())' value='@types.Value'>@types.Text</option>
                        }
                    </select>
                    <input asp-for="@link.url" id="@link.id" class="form-control mb-3 imgList imgAdd input-style w-50 me-2 input-style-disabled" disabled />
                    <button type="button" class="btn btn-edit h-50 me-2" onclick="editInput(this, 'source')">Editar</button>
                    <button type="button" class="btn btn-delete h-50" onclick="removeInput(this, 'source')">Eliminar</button>
                </div>
            }

            <div id="inputContainerLinks"></div>

            <button type="button" class="btn btn-add mb-5 d-flex" onclick="addInputSource()">Agregar Link</button>
            <!-- TODOD AGREGAR LINKS -->

            <button type="submit" class="btn btn-edit" onclick="enviarDatosAlServidor()">Editar</button>
            <button type="button" asp-route-format="@Model.format" id="btnBorrador" class="btn btn-borrador" onclick="borrador()">@(Model.draft ? "Publicar" : "Borrador")</button>
            <a asp-action="Index" asp-route-format="@Model.format" class="btn btn-delete"><i class="fa-solid fa-arrow-rotate-left"></i> Regresar</a>
        </div>

        <!--SECTION HOME-->
        <div class=" col-md-3 col-12 d-flex flex-column gap-2 me-4">
            <div class="border-section" id="selectHomeSection">
                <h3 class="fs-5">Sección</h3>
                <select class="form-select select-style" id="selectHomeSectionName" asp-for="@Model.HomeSectionPost.HomeSectionId" onchange="actualizarItems()">
                    <option value="0" selected>Ninguna</option>
                    @foreach (var sectionHome in @Model.HomeSectionList)
                    {
                        <option value="@sectionHome.Id" data-items="@sectionHome.MaxItems">@sectionHome.Name</option>
                    }
                </select>
                @if (Model.HomeSectionPost?.Order > 0)
                {
                    <select class="form-select select-style mt-2" id="selectHomeSectionItems" asp-for="@Model.HomeSectionPost.Order">
                        @for (int i = 1; i <= Model.HomeSectionList.FirstOrDefault(e => e.Id == Model.HomeSectionPost.HomeSectionId)?.MaxItems; i++)
                        {
                            <option value="@i">@i</option>
                        }
                    </select>
                }
            </div>
        </div>
    </form>

</div>

@section Scripts
{
    <partial name="_ValidationScriptsPartial" />
    <partial name="_Modal" model='new { url = "/Posts", action = "Borrar" }' />

    <script>

        function agregarCategorias() {
            let objs = []; // Eliminamos la anotación de tipo porque no es válida en JavaScript

        @if (Model?.categoryList != null)
        {
                                @foreach (var item in Model.categoryList)
                                {
                                                        <text>
                                                                objs.push({
                                                                    id: @item.Categoria.id,
                                                                    postId: @Model.id,
                                                                    name: "@Html.Raw(item.Categoria.name)"
                                                                });
                                                        </text>
                                }
        }

                objs.forEach(x => addCategoryRefresh(x));
        }

        // Llama automáticamente a la función después de definirla
        agregarCategorias();

        function addInputMedia() {
            //Agregamos elemento nuevo para agragar nuevo medias
            var container = document.getElementById('inputContainerMedia');
            var div = document.createElement('div');
            div.className = 'input-group';

            // Creamos el select
            var select = document.createElement('select');
            select.className = 'form-select mb-3 select-style w-25';

            // Agregamos opciones al select utilizando los SelectListItem del modelo
        @foreach (var item in Model.mediaTypes)
        {
                                <text>
                                    var option = document.createElement("option");
                                    option.text = "@item.Text";
                                    option.value = "@item.Value";
                                    select.add(option);
                                </text>
        }
                // Agregamos el select al div
                div.appendChild(select);

            // Creamos el input
            var input = document.createElement('input');
            input.className = 'form-control mb-3 imgList imgAdd input-style w-50';
            input.placeholder = 'Ingrese link multimedia';
            // Agregamos el input al div
            div.appendChild(input);

            // Creamos los botones
            var addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'btn btn-action ms-2 h-50';
            addButton.textContent = 'Agregar';
            addButton.onclick = function () { addList(this, "post"); };
            // Agregamos el botón al div
            div.appendChild(addButton);

            var removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-delete ms-2 h-50';
            removeButton.textContent = 'Eliminar';
            removeButton.onclick = function () { removeInput(this, "post"); };
            // Agregamos el botón al div
            div.appendChild(removeButton);

            // Agregamos el div al contenedor
            container.appendChild(div);
        }

        function addInputSource() {
            //Agregamos elemento nuevo para agragar nuevo medias
            var container = document.getElementById('inputContainerLinks');
            var div = document.createElement('div');
            div.className = 'input-group';

            // Creamos el select
            var select = document.createElement('select');
            select.className = 'form-select mb-3 select-style w-25';

            // Agregamos opciones al select utilizando los SelectListItem del modelo
        @foreach (var item in Model.sources)
        {
                                <text>
                                    var option = document.createElement("option");
                                    option.text = "@item.Text";
                                    option.value = "@item.Value";
                                    select.add(option);
                                </text>
        }
                // Agregamos el select al div
                div.appendChild(select);

            // Creamos el input
            var input = document.createElement('input');
            input.className = 'form-control mb-3 imgList imgAdd input-style w-50';
            input.placeholder = 'Ingrese link o fuente';
            // Agregamos el input al div
            div.appendChild(input);

            // Creamos los botones
            var addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'btn btn-action ms-2 h-50';
            addButton.textContent = 'Agregar';
            addButton.onclick = function () { addList(this, "source"); };
            // Agregamos el botón al div
            div.appendChild(addButton);

            var removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-delete ms-2 h-50';
            removeButton.textContent = 'Eliminar';
            removeButton.onclick = function () { removeInput(this, "source"); };
            // Agregamos el botón al div
            div.appendChild(removeButton);

            // Agregamos el div al contenedor
            container.appendChild(div);
        }

                // Seleccion de número de orden
        function actualizarItems() {
            const container = document.getElementById("selectHomeSection");
            const oldSelect = document.getElementById("selectHomeSectionItems");

            // Eliminar el select anterior si existe
            if (oldSelect) {
                container.removeChild(oldSelect);
            }

            const sectionSelect = document.getElementById("selectHomeSectionName");
            const selectedOption = sectionSelect.options[sectionSelect.selectedIndex];
            const totalItems = parseInt(selectedOption.getAttribute("data-items"), 10);

            if (isNaN(totalItems) || totalItems <= 0) {
                console.warn("Cantidad de items inválida.");
                return;
            }

            // Crear nuevo select
            const newSelect = document.createElement("select");
            newSelect.id = "selectHomeSectionItems";
            newSelect.name = "HomeSectionPost.Order";
            newSelect.className = "form-select select-style mt-3";

            for (let i = 1; i <= totalItems; i++) {
                const option = document.createElement("option");
                option.value = i;
                option.textContent = i;
                newSelect.appendChild(option);
            }

            container.appendChild(newSelect);
        }
    </script>
}